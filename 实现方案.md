# 压缩包文件信息预览功能实现方案

## 现有子包分析

### 当前子包结构
- `internal/bzip2/` - BZ2格式处理
- `internal/gzip/` - GZIP格式处理  
- `internal/tar/` - TAR格式处理
- `internal/tgz/` - TGZ格式处理
- `internal/zip/` - ZIP格式处理
- `types/` - 类型定义

### 各子包特点
1. **ZIP包**: 支持目录结构，有文件头信息
2. **TAR包**: 支持目录结构，有详细文件属性
3. **GZIP包**: 单文件压缩，文件信息有限
4. **TGZ包**: TAR+GZIP组合，结合两者特点
5. **BZ2包**: 单文件压缩，类似GZIP

## 统一数据结构设计

### 核心结构体定义

```go
// FileInfo 压缩包内文件信息
type FileInfo struct {
    Name         string    // 文件名/路径
    Size         int64     // 原始大小
    CompressedSize int64   // 压缩后大小
    ModTime      time.Time // 修改时间
    Mode         os.FileMode // 文件权限
    IsDir        bool      // 是否为目录
    IsSymlink    bool      // 是否为符号链接
    LinkTarget   string    // 符号链接目标(如果是符号链接)
    CRC32        uint32    // CRC32校验值(如果支持)
    Method       string    // 压缩方法
}

// ArchiveInfo 压缩包整体信息
type ArchiveInfo struct {
    Type         CompressType // 压缩包类型
    TotalFiles   int          // 总文件数
    TotalSize    int64        // 总原始大小
    CompressedSize int64      // 总压缩大小
    Files        []FileInfo   // 文件列表
}
```

## 接口设计

### 统一接口定义

```go
// ArchiveReader 压缩包读取接口
type ArchiveReader interface {
    // ListAll 获取压缩包的所有文件信息
    ListAll(archivePath string) (*ArchiveInfo, error)
    
    // ListLimit 获取指定数量的文件信息
    ListLimit(archivePath string, limit int) (*ArchiveInfo, error)
    
    // ListMatch 获取匹配指定模式的文件信息
    ListMatch(archivePath string, pattern string) (*ArchiveInfo, error)
}

// ArchivePrinter 压缩包打印接口
type ArchivePrinter interface {
    // PrintAll 打印压缩包的所有文件信息
    PrintAll(archivePath string) error
    
    // PrintLimit 打印指定数量的文件信息
    PrintLimit(archivePath string, limit int) error
    
    // PrintMatch 打印匹配指定模式的文件信息
    PrintMatch(archivePath string, pattern string) error
}
```

## 各子包实现方案

### 1. ZIP包实现 (`internal/zip/`)

**新增文件**: `list.go`

**实现要点**:
- 利用 `archive/zip.OpenReader` 读取文件头
- 遍历 `zip.File` 获取详细信息
- 支持完整的文件属性(大小、时间、权限等)
- 支持CRC32校验值

**核心方法**:
```go
func ListZip(archivePath string) (*ArchiveInfo, error)
func ListZipLimit(archivePath string, limit int) (*ArchiveInfo, error)
func ListZipMatch(archivePath string, pattern string) (*ArchiveInfo, error)
```

### 2. TAR包实现 (`internal/tar/`)

**新增文件**: `list.go`

**实现要点**:
- 使用 `archive/tar.NewReader` 遍历条目
- 从 `tar.Header` 获取文件信息
- 支持符号链接目标信息
- 支持Unix文件权限

**核心方法**:
```go
func ListTar(archivePath string) (*ArchiveInfo, error)
func ListTarLimit(archivePath string, limit int) (*ArchiveInfo, error)
func ListTarMatch(archivePath string, pattern string) (*ArchiveInfo, error)
```

### 3. TGZ包实现 (`internal/tgz/`)

**新增文件**: `list.go`

**实现要点**:
- 先用 `gzip.NewReader` 解压GZIP层
- 再用 `tar.NewReader` 读取TAR内容
- 复用TAR的文件信息提取逻辑

### 4. GZIP包实现 (`internal/gzip/`)

**新增文件**: `list.go`

**实现要点**:
- 使用 `gzip.NewReader` 读取文件头
- 单文件信息相对简单
- 从GZIP头获取原始文件名和修改时间

### 5. BZ2包实现 (`internal/bzip2/`)

**新增文件**: `list.go`

**实现要点**:
- BZ2格式信息有限，主要获取压缩大小
- 可能需要部分解压来获取原始大小

## 工具函数设计

### 通用工具函数

```go
// 在 internal/utils/ 中新增 list.go

// FormatFileSize 格式化文件大小显示
func FormatFileSize(size int64) string

// FormatFileMode 格式化文件权限显示  
func FormatFileMode(mode os.FileMode) string

// MatchPattern 文件名模式匹配
func MatchPattern(name, pattern string) bool

// PrintFileInfo 格式化打印单个文件信息
func PrintFileInfo(info FileInfo, showDetails bool)

// PrintArchiveInfo 格式化打印压缩包信息
func PrintArchiveInfo(archiveInfo *ArchiveInfo, showSummary bool)
```

## 独立列表功能设计方案

### 设计理念
- **职责分离**: Comprx 专注压缩/解压，列表功能独立
- **代码清晰**: 避免 Comprx 结构体过于臃肿
- **易于维护**: 列表功能可以独立测试和优化
- **扩展性好**: 后续可以轻松添加更多列表相关功能

### 新增文件结构

```
comprx/
├── comprx.go           # 现有压缩/解压功能
├── list.go             # 新增列表功能入口 (包级别函数)
├── types/
│   ├── types.go        # 现有类型定义
│   └── list.go         # 新增列表相关类型定义
├── internal/
│   ├── zip/
│   │   ├── zip.go      # 现有
│   │   ├── unzip.go    # 现有
│   │   └── list.go     # 新增ZIP列表功能
│   ├── tar/
│   │   ├── tar.go      # 现有
│   │   ├── untar.go    # 现有
│   │   └── list.go     # 新增TAR列表功能
│   ├── tgz/
│   │   ├── tgz.go      # 现有
│   │   ├── untgz.go    # 现有
│   │   └── list.go     # 新增TGZ列表功能
│   ├── gzip/
│   │   ├── gzip.go     # 现有
│   │   ├── ungzip.go   # 现有
│   │   └── list.go     # 新增GZIP列表功能
│   ├── bzip2/
│   │   ├── unbzip2.go  # 现有
│   │   └── list.go     # 新增BZ2列表功能
│   └── utils/
│       ├── utils.go    # 现有
│       ├── buffer.go   # 现有
│       └── list.go     # 新增列表工具函数
```

### 包级别函数设计 (方案A)

在根目录新增 `list.go` 文件，提供包级别的便捷函数：

```go
// List 列出压缩包的所有文件信息
func List(archivePath string) (*types.ArchiveInfo, error)

// ListLimit 列出指定数量的文件信息
func ListLimit(archivePath string, limit int) (*types.ArchiveInfo, error)

// ListMatch 列出匹配指定模式的文件信息
func ListMatch(archivePath string, pattern string) (*types.ArchiveInfo, error)

// PrintList 打印压缩包的所有文件信息
func PrintList(archivePath string) error

// PrintListLimit 打印指定数量的文件信息
func PrintListLimit(archivePath string, limit int) error

// PrintListMatch 打印匹配指定模式的文件信息
func PrintListMatch(archivePath string, pattern string) error
```

### 调用方式示例

```go
// 获取文件信息
info, err := comprx.List("archive.zip")
if err != nil {
    log.Fatal(err)
}

// 直接打印文件信息
err = comprx.PrintList("archive.zip")

// 限制显示数量
err = comprx.PrintListLimit("archive.zip", 10)

// 模式匹配
info, err = comprx.ListMatch("archive.zip", "*.go")
```

### 与现有功能的一致性

这种设计与现有的便捷函数保持一致：

```go
// 现有便捷函数
comprx.Pack("archive.zip", "source/")
comprx.Unpack("archive.zip", "dest/")

// 新增列表函数
comprx.List("archive.zip")
comprx.PrintList("archive.zip")
```

## 实现优先级

### 第一阶段 (核心功能)
1. 定义统一数据结构 (`types/list.go`)
2. 实现ZIP包列表功能 (最完整的信息)
3. 实现TAR包列表功能
4. 添加通用工具函数

### 第二阶段 (扩展功能)
1. 实现TGZ包列表功能
2. 实现GZIP包列表功能
3. 实现BZ2包列表功能
4. 完善打印格式和用户体验

### 第三阶段 (优化完善)
1. 添加性能优化(大文件处理)
2. 添加错误处理和边界检查
3. 添加单元测试
4. 文档完善

## 技术难点和解决方案

### 1. 不同格式信息差异
**解决方案**: 使用统一结构体，不支持的字段设为默认值

### 2. 大压缩包性能问题
**解决方案**: 
- 实现流式读取
- 支持限制读取数量
- 添加进度显示

### 3. 模式匹配复杂性
**解决方案**:
- 支持简单通配符 (`*`, `?`)
- 支持正则表达式匹配
- 支持路径匹配

## 总结

这个实现方案保持了现有代码结构的一致性，同时为每种压缩格式提供了统一的文件信息预览功能。通过分阶段实现，可以逐步完善功能，确保代码质量和用户体验。